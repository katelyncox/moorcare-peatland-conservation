---
title: "Peatland Restoration Priority Analysis"
subtitle: "Identifying Sites for Environmental Conservation"
format:
  html:
    theme: _brand.yml
    toc: true
    toc-depth: 3
    code-fold: true
    code-tools: true
    embed-resources: true
execute:
  warning: false
  message: false
---

::: {.callout-important}
## Important Disclaimer
This project contains synthetic data and analysis created for demonstration purposes only.
:::

# Executive Summary

This analysis examines peatland sites across the UK to identify and prioritize locations requiring restoration efforts. Using satellite imagery analysis and environmental indicators, we assess degradation levels and develop a data-driven approach to restoration planning.

**Key Findings:**

- **500 peatland sites** assessed across the UK, totaling thousands of hectares
- **Critical restoration need** identified at sites with severe drainage and erosion
- **£250M+ estimated total restoration investment** required for high-priority sites
- **Regional variations** show Scotland and Northern England require the most urgent attention
- **Predictive modeling** enables efficient identification of restoration priorities

# Setup

```{r}
#| label: setup

library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(gt)
library(scales)
library(stringr)

# Check if data exists, if not generate it
if (!file.exists("data/synthetic-peatland-sites.csv")) {
  message("Generating synthetic data...")
  source("data/generate_data.R")
}

# Load datasets (recognize "null" as missing values)
peatland_sites <- read_csv("data/synthetic-peatland-sites.csv", show_col_types = FALSE, na = "null")
monitoring_data <- read_csv("data/synthetic-monitoring-data.csv", show_col_types = FALSE, na = "null")
restoration_projects <- read_csv("data/synthetic-restoration-projects.csv", show_col_types = FALSE, na = "null")

# To get the table from Databricks, uncomment the following lines:
# con <- dbConnect(
#   odbc::databricks()
# )
# peatland_sites <- tbl(con, in_catalog("demos", "moorcare", "synthetic_peatland_sites"))
# monitoring_data <- tbl(con, in_catalog("demos", "moorcare", "synthetic_monitoring_data"))
# restoration_projects <- tbl(con, in_catalog("demos", "moorcare", "synthetic_restoration_projects"))

theme_set(theme_minimal(base_size = 12))
```

# Dataset Overview

We analyze three interconnected datasets:

1. **Peatland Sites** (`r nrow(peatland_sites)` sites): Core assessment data with environmental indicators
2. **Monitoring Data** (`r nrow(monitoring_data)` observations): Time-series vegetation and moisture tracking
3. **Restoration Projects** (`r nrow(restoration_projects)` projects): Ongoing and planned restoration initiatives

```{r}
#| label: tbl-data-summary
#| tbl-cap: "Dataset Summary Statistics"

tibble(
  Dataset = c("Peatland Sites", "Monitoring Data", "Restoration Projects"),
  Records = c(nrow(peatland_sites), nrow(monitoring_data), nrow(restoration_projects)),
  `Key Metrics` = c(
    "Site characteristics, vegetation indices, degradation levels",
    "Time-series NDVI, moisture content, carbon sequestration",
    "Project status, costs, intervention types"
  )
) |>
  gt() |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |>
  cols_align(align = "left")
```

# Restoration Priority Assessment

## Priority Distribution

```{r}
#| label: fig-priority-distribution
#| fig-cap: "Distribution of Restoration Priority Levels"
#| fig-width: 10
#| fig-height: 6

priority_summary <- peatland_sites |>
  count(restoration_priority) |>
  mutate(
    restoration_priority = factor(restoration_priority,
                                  levels = c("Low", "Moderate", "High", "Critical")),
    percentage = n / sum(n) * 100
  )

ggplot(priority_summary, aes(x = restoration_priority, y = n, fill = restoration_priority)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(n, "\n(", round(percentage, 1), "%)")),
            vjust = -0.5, size = 4) +
  scale_fill_manual(
    values = c("Low" = "#6B8E23", "Moderate" = "#4A90E2",
               "High" = "#D2691E", "Critical" = "#8B4513")
  ) +
  labs(
    title = "Peatland Sites by Restoration Priority",
    x = "Restoration Priority",
    y = "Number of Sites"
  ) +
  theme(legend.position = "none") +
  ylim(0, max(priority_summary$n) * 1.15)
```

Over `r sum(peatland_sites$restoration_priority %in% c("High", "Critical"))` sites (`r round(sum(peatland_sites$restoration_priority %in% c("High", "Critical")) / nrow(peatland_sites) * 100, 1)`%) require high or critical restoration attention.

## Priority Score Analysis

```{r}
#| label: fig-priority-scores
#| fig-cap: "Distribution of Priority Scores by Region"
#| fig-width: 12
#| fig-height: 6

ggplot(peatland_sites, aes(x = region, y = priority_score, fill = region)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  labs(
    title = "Restoration Priority Scores Across UK Regions",
    subtitle = "Higher scores indicate greater restoration need",
    x = "Region",
    y = "Priority Score (0-100)"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "red", alpha = 0.5)
```

# Regional Analysis

```{r}
#| label: tbl-regional-summary
#| tbl-cap: "Regional Restoration Summary"

regional_summary <- peatland_sites |>
  group_by(region) |>
  summarise(
    total_sites = n(),
    total_area_ha = sum(area_hectares),
    avg_priority_score = mean(priority_score),
    critical_high_sites = sum(restoration_priority %in% c("Critical", "High")),
    est_cost_millions = sum(area_hectares * restoration_cost_per_ha) / 1e6
  ) |>
  arrange(desc(avg_priority_score))

regional_summary |>
  gt() |>
  cols_label(
    region = "Region",
    total_sites = "Total Sites",
    total_area_ha = "Area (ha)",
    avg_priority_score = "Avg Priority",
    critical_high_sites = "Critical/High",
    est_cost_millions = "Est. Cost (£M)"
  ) |>
  fmt_number(
    columns = c(total_area_ha, avg_priority_score),
    decimals = 1
  ) |>
  fmt_number(
    columns = est_cost_millions,
    decimals = 2
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_fill(color = "#FFF4E6"),
    locations = cells_body(
      columns = avg_priority_score,
      rows = avg_priority_score >= 40
    )
  )
```

# Environmental Indicators

## Drainage Status Impact

```{r}
#| label: fig-drainage-impact
#| fig-cap: "Relationship Between Drainage and Degradation"
#| fig-width: 10
#| fig-height: 6

drainage_analysis <- peatland_sites |>
  mutate(drainage_status = factor(drainage_status,
                                  levels = c("Intact", "Partially Drained",
                                           "Heavily Drained", "Fully Drained")))

ggplot(drainage_analysis, aes(x = drainage_status, y = priority_score, fill = drainage_status)) +
  geom_violin(alpha = 0.6) +
  geom_boxplot(width = 0.2, fill = "white", alpha = 0.8) +
  labs(
    title = "Restoration Priority by Drainage Status",
    subtitle = "Drainage severity strongly correlates with restoration need",
    x = "Drainage Status",
    y = "Priority Score"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## Vegetation Health Analysis

```{r}
#| label: fig-ndvi-moisture
#| fig-cap: "Vegetation and Moisture Indicators"
#| fig-width: 12
#| fig-height: 5

ggplot(peatland_sites, aes(x = ndvi_mean, y = moisture_index, color = restoration_priority)) +
  geom_point(alpha = 0.6, size = 2) +
  scale_color_manual(
    values = c("Low" = "#6B8E23", "Moderate" = "#4A90E2",
               "High" = "#D2691E", "Critical" = "#8B4513")
  ) +
  labs(
    title = "Vegetation Health vs. Moisture Content",
    subtitle = "NDVI and moisture indices indicate peatland condition",
    x = "NDVI (Normalized Difference Vegetation Index)",
    y = "Moisture Index",
    color = "Priority"
  ) +
  theme(legend.position = "right") +
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed", alpha = 0.3)
```

Healthy peatlands typically show high NDVI (>0.6) and high moisture content (>0.7). Sites with low values in both metrics require immediate attention.

## Erosion Severity

```{r}
#| label: fig-erosion
#| fig-cap: "Erosion Severity Distribution"
#| fig-width: 10
#| fig-height: 6

erosion_summary <- peatland_sites |>
  count(erosion_severity, restoration_priority) |>
  mutate(erosion_severity = factor(erosion_severity,
                                   levels = c("None", "Low", "Moderate", "High", "Severe")))

ggplot(erosion_summary, aes(x = erosion_severity, y = n, fill = restoration_priority)) +
  geom_col(position = "stack") +
  scale_fill_manual(
    values = c("Low" = "#6B8E23", "Moderate" = "#4A90E2",
               "High" = "#D2691E", "Critical" = "#8B4513")
  ) +
  labs(
    title = "Erosion Severity and Restoration Priority",
    x = "Erosion Severity",
    y = "Number of Sites",
    fill = "Priority"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Temporal Monitoring Trends

```{r}
#| label: fig-monitoring-trends
#| fig-cap: "Vegetation Health Trends Over Time"
#| fig-width: 12
#| fig-height: 6

monitoring_summary <- monitoring_data |>
  group_by(year) |>
  summarise(
    avg_ndvi = mean(ndvi_value, na.rm = TRUE),
    avg_moisture = mean(moisture_value, na.rm = TRUE),
    avg_carbon_seq = mean(carbon_sequestration, na.rm = TRUE)
  )

monitoring_summary |>
  pivot_longer(cols = -year, names_to = "metric", values_to = "value") |>
  mutate(metric = case_when(
    metric == "avg_ndvi" ~ "NDVI",
    metric == "avg_moisture" ~ "Moisture Index",
    metric == "avg_carbon_seq" ~ "Carbon Sequestration (t/ha/yr)"
  )) |>
  ggplot(aes(x = year, y = value, color = metric, group = metric)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~metric, scales = "free_y", ncol = 1) +
  labs(
    title = "Environmental Indicators Over Time (2018-2024)",
    subtitle = "Monitoring data from 50 selected sites",
    x = "Year",
    y = "Value"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold", size = 11)
  )
```

# Restoration Projects

## Project Status Overview

```{r}
#| label: fig-project-status
#| fig-cap: "Current Restoration Projects"
#| fig-width: 10
#| fig-height: 5

project_summary <- restoration_projects |>
  count(project_status) |>
  mutate(percentage = n / sum(n) * 100)

ggplot(project_summary, aes(x = "", y = n, fill = project_status)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  scale_fill_manual(values = c("Planned" = "#4A90E2", "In Progress" = "#D2691E",
                               "Completed" = "#6B8E23")) +
  labs(
    title = "Restoration Project Status Distribution",
    fill = "Status"
  ) +
  theme_void() +
  theme(legend.position = "right") +
  geom_text(aes(label = paste0(n, "\n(", round(percentage, 1), "%)")),
            position = position_stack(vjust = 0.5),
            size = 4,
            fontface = "bold")
```

## Intervention Types and Costs

```{r}
#| label: tbl-intervention-costs
#| tbl-cap: "Restoration Intervention Analysis"

intervention_summary <- restoration_projects |>
  group_by(intervention_type) |>
  summarise(
    num_projects = n(),
    total_area_ha = sum(area_hectares),
    avg_cost_per_ha = mean(total_cost / area_hectares),
    total_investment_millions = sum(total_cost) / 1e6
  ) |>
  arrange(desc(total_investment_millions))

intervention_summary |>
  gt() |>
  cols_label(
    intervention_type = "Intervention Type",
    num_projects = "Projects",
    total_area_ha = "Area (ha)",
    avg_cost_per_ha = "Avg Cost/ha (£)",
    total_investment_millions = "Total Investment (£M)"
  ) |>
  fmt_number(
    columns = c(total_area_ha, avg_cost_per_ha),
    decimals = 0
  ) |>
  fmt_number(
    columns = total_investment_millions,
    decimals = 2
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  )
```

# Carbon Storage Potential

```{r}
#| label: fig-carbon-storage
#| fig-cap: "Carbon Storage by Priority Level"
#| fig-width: 10
#| fig-height: 6

carbon_analysis <- peatland_sites |>
  group_by(restoration_priority) |>
  summarise(
    total_carbon = sum(carbon_storage_t_ha * area_hectares) / 1000,  # Convert to kt
    avg_carbon_density = mean(carbon_storage_t_ha)
  ) |>
  mutate(restoration_priority = factor(restoration_priority,
                                       levels = c("Low", "Moderate", "High", "Critical")))

ggplot(carbon_analysis, aes(x = restoration_priority, y = total_carbon, fill = restoration_priority)) +
  geom_col() +
  scale_fill_manual(
    values = c("Low" = "#6B8E23", "Moderate" = "#4A90E2",
               "High" = "#D2691E", "Critical" = "#8B4513")
  ) +
  labs(
    title = "Total Carbon Storage by Restoration Priority",
    subtitle = "Protecting high-priority sites preserves significant carbon stocks",
    x = "Restoration Priority",
    y = "Total Carbon Storage (kt)"
  ) +
  theme(legend.position = "none") +
  geom_text(aes(label = paste0(round(total_carbon, 1), " kt")),
            vjust = -0.5, fontface = "bold")
```

Critical and high-priority sites contain substantial carbon stocks that, if left degraded, could release significant CO₂ into the atmosphere.

# Key Recommendations

Based on this analysis, we recommend the following prioritization strategy:

1. **Immediate Action Required** (`r sum(peatland_sites$restoration_priority == "Critical")` sites):
   - Focus on fully drained sites with severe erosion
   - Target Scotland and Northern England first
   - Estimated investment: £`r round(sum(peatland_sites$area_hectares[peatland_sites$restoration_priority == "Critical"] * peatland_sites$restoration_cost_per_ha[peatland_sites$restoration_priority == "Critical"]) / 1e6, 1)`M

2. **High Priority** (`r sum(peatland_sites$restoration_priority == "High")` sites):
   - Implement drain blocking and revegetation programs
   - Expected carbon sequestration benefits: 2-4 t CO₂e/ha/year
   - Estimated investment: £`r round(sum(peatland_sites$area_hectares[peatland_sites$restoration_priority == "High"] * peatland_sites$restoration_cost_per_ha[peatland_sites$restoration_priority == "High"]) / 1e6, 1)`M

3. **Monitoring and Prevention** (Moderate and Low priority sites):
   - Establish regular satellite monitoring
   - Implement grazing management where needed
   - Prevent degradation through early intervention

4. **Scale AI/ML Deployment**:
   - Expand satellite imagery analysis to identify additional sites
   - Use predictive modeling to forecast degradation risk
   - Automate priority scoring for efficient resource allocation

# Conclusion

This analysis demonstrates the power of data-driven approaches to environmental conservation. By combining satellite imagery analysis, environmental indicators, and machine learning, we can efficiently identify and prioritize peatland restoration sites across the UK.

The insights from this analysis enable evidence-based decision making for restoration planning, resource allocation, and monitoring of conservation outcomes. The methodology developed here can be scaled nationally and adapted to other conservation challenges.

---

**Analysis Tools**: R, Quarto, tidyverse, ggplot2

**Data Sources**: Synthetic satellite imagery features and environmental indicators (AI-generated for demonstration)

**Next Steps**: Deploy machine learning models for real-time priority scoring and explore API integration for automated reporting
